<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងការលក់_YL</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Hide main content when printing, only show invoice section */
        .invoice-print-section {
            display: none;
        }
        @media print {
            body > *:not(.invoice-print-section) {
                display: none;
            }
            /* Styling for 80mm thermal receipt printer */
            .invoice-print-section {
                display: block;
                font-family: sans-serif;
                color: #000;
                width: 80mm;
                padding: 5mm;
                box-sizing: border-box;
                margin: 0;
            }
        }
        /* Custom modal for alerts and confirmations */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff; /* Reverted to white for light/clear appearance */
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Overriding modal width for edit form and rich messages */
        #editModal .modal-content, #messageModal .modal-content {
            max-width: 550px;
            text-align: left;
        }
        #messageModal .modal-content {
             /* Reset alignment for main modal messages */
            text-align: center;
        }
        #modalRichContent {
            text-align: left;
        }
        .modal-buttons {
            margin-top: 16px;
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        /* Loading Screen Styles */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        /* Refined loading spinner */
        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Hide repeated information in the history table (now card view) */
        .invoice-row:not(:first-child) .invoice-number-cell,
        .invoice-row:not(:first-child) .customer-info-cell {
            visibility: hidden;
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark-mode .bg-white {
            background-color: #2d3748;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #1a202c;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #2d3748;
        }
        body.dark-mode .bg-gray-200 {
            background-color: #4a5568;
        }
        body.dark-mode .text-gray-900,
        body.dark-mode .text-gray-700,
        body.dark-mode .text-gray-500,
        body.dark-mode .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark-mode .bg-white.hover\:bg-gray-100:hover {
            background-color: #4a5568;
        }
        body.dark-mode .hover\:bg-gray-100:hover {
            background-color: #4a5568;
        }
        body.dark-mode .bg-indigo-50 {
            background-color: #2a384a;
        }
        body.dark-mode .bg-green-50 {
            background-color: #1f3b33;
        }
        body.dark-mode .bg-yellow-50 {
            background-color: #3b361a;
        }
        body.dark-mode .text-indigo-700, body.dark-mode .text-indigo-800,
        body.dark-mode .text-green-700, body.dark-mode .text-green-800,
        body.dark-mode .text-yellow-700, body.dark-mode .text-yellow-800 {
            color: #e2e8f0;
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode input::placeholder, body.dark-mode select::placeholder, body.dark-mode textarea::placeholder {
            color: #a0aec0;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
            <div id="modalRichContent" class="mt-4 text-left text-sm text-gray-700 space-y-1">
                <!-- Rich content for conflict message goes here -->
            </div>
            <div class="modal-buttons">
                <button id="modalOkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <!-- Modal for confirmations -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmMessage" class="text-lg font-semibold text-gray-800"></p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">បាទ/ចាស</button>
                <button id="confirmNoBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">ទេ</button>
            </div>
        </div>
    </div>

    <!-- Modal for Editing Customer Info -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">កែប្រែព័ត៌មានអតិថិជន</h2>
            <input type="hidden" id="editDocId">
            <div class="space-y-3">
                <div>
                    <label for="editCustomerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជន</label>
                    <input type="text" id="editCustomerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                
                <!-- Removed editFacebookProfileUrl -->

                <div>
                    <label for="editCustomerPhone" class="block text-sm font-medium text-gray-700">លេខទូរស័ព្ទ</label>
                    <input type="text" id="editCustomerPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="editCustomerAddress" class="block text-sm font-medium text-gray-700">អាសយដ្ឋាន</label>
                    <input type="text" id="editCustomerAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                
                <!-- NEW: Store Name -->
                <div class="pt-2">
                    <label for="editStoreName" class="block text-sm font-medium text-gray-700">ហាង</label>
                    <select id="editStoreName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="វិក្កយបត្រ">វិក្កយបត្រ (Default)</option>
                        <option value="CCR Online Store">CCR Online Store</option>
                        <option value="YL 99CCR">YL 99CCR</option>
                        <option value="CCR168">CCR168</option>
                    </select>
                </div>

                <div class="pt-2">
                    <label for="editDeliveryOption" class="block text-sm font-medium text-gray-700">ជម្រើសសម្រាប់ការដឹកជញ្ជូន</label>
                    <select id="editDeliveryOption" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="VET">VET</option>
                        <option value="J&T">J&T</option>
                        <option value="ភ្នំពេញ">ភ្នំពេញ</option>
                        <option value="មិនបានជ្រើសរើស">មិនបានជ្រើសរើស</option>
                    </select>
                </div>
                
                <div class="pt-2">
                    <label for="editDeliveryFee" class="block text-sm font-medium text-gray-700">តម្លៃសេវាដឹក (ដុល្លារ)</label>
                    <input type="number" id="editDeliveryFee" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>

                <!-- UPDATED: Payment Option Select (Drop-down list) -->
                <div class="pt-2">
                    <label for="editPaymentOptionSelect" class="block text-sm font-medium text-gray-700">ជម្រើសការទូទាត់</label>
                    <select id="editPaymentOptionSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="AC">AC</option>
                        <option value="ABA">ABA</option>
                        <option value="Wing">Wing</option>
                        <option value="True Emoney">True Emoney</option>
                        <option value="តាមអ្នកដឹក">តាមអ្នកដឹក</option>
                        <option value="ធនាគារផ្សេង">ធនាគារផ្សេង (Custom)</option>
                        <option value="មិនទាន់វេទឹកប្រាក់">មិនទាន់វេទឹកប្រាក់ (Unpaid)</option>
                    </select>
                </div>
                <!-- NEW: Custom Payment Input (visible if "ធនាគារផ្សេង" selected) -->
                <div class="pt-2 hidden" id="editOtherPaymentContainer">
                    <label for="editOtherPaymentInput" class="block text-sm font-medium text-gray-700">ឈ្មោះធនាគារ/ការទូទាត់ផ្សេងទៀត</label>
                    <input type="text" id="editOtherPaymentInput" placeholder="ដូចជា: ធនាគារ Wing Bank, វីង, ផ្សេងៗ..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>

                <!-- RETAINED: Payment Notes / TxD -->
                <div class="pt-2">
                    <label for="editPaymentNotes" class="block text-sm font-medium text-gray-700">កំណត់សម្គាល់បន្ថែម (លេខ TxD)</label>
                    <input type="text" id="editPaymentNotes" placeholder="លេខ TxD" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
            </div>
            <div class="modal-buttons">
                <button id="editSaveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">រក្សាទុក</button>
                <button id="editCancelBtn" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition duration-300">បោះបង់</button>
            </div>
        </div>
    </div>

    <!-- Loading message container -->
    <div id="loadingView" class="loading-container">
        <div class="flex flex-col items-center p-8 bg-white rounded-lg shadow-lg">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-gray-700 font-semibold">កំពុងផ្ទុកទិន្នន័យ...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="mainApp" class="flex w-full flex-col hidden">
        <!-- Top Navigation Bar (Updated to Indigo 700) -->
        <nav class="bg-indigo-700 text-white p-4 flex items-center justify-between flex-wrap">
            <div class="flex items-center gap-4 mb-2 sm:mb-0">
                <!-- Nav buttons container: Use horizontal scroll and smaller gap/padding on mobile (sm: is for desktop size restore) -->
                <div class="flex items-center space-x-1 overflow-x-auto pb-1 sm:space-x-2">
                    <!-- Dashboard Button (Active Default Style) -->
                    <button id="dashboardNavBtn" class="px-3 py-1.5 text-sm rounded-md font-medium text-white bg-indigo-900 hover:bg-indigo-800 transition duration-300 flex items-center gap-1.5 sm:px-4 sm:py-2 sm:text-base sm:gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
                        <span class="whitespace-nowrap">ផ្ទាំងគ្រប់គ្រង</span>
                    </button>
                    <!-- Customer Info Button (Inactive Default Style) -->
                    <button id="customerInfoNavBtn" class="px-3 py-1.5 text-sm rounded-md font-medium text-indigo-100 hover:bg-indigo-600 transition duration-300 flex items-center gap-1.5 sm:px-4 sm:py-2 sm:text-base sm:gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zm-1.5 6a4.5 4.5 0 00-4.5 4.5V18h9v-1.5A4.5 4.5 0 0011.5 12z" clip-rule="evenodd" fill-rule="evenodd" /></svg>
                        <span class="whitespace-nowrap">ព័ត៌មានអតិថិជន</span>
                    </button>
                    <!-- Add Item Button (Inactive Default Style) -->
                    <button id="addItemNavBtn" class="px-3 py-1.5 text-sm rounded-md font-medium text-indigo-100 hover:bg-indigo-600 transition duration-300 flex items-center gap-1.5 sm:px-4 sm:py-2 sm:text-base sm:gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        <span class="whitespace-nowrap">បន្ថែមទំនិញ</span>
                    </button>
                    <!-- History Button (Inactive Default Style) -->
                    <button id="historyNavBtn" class="px-3 py-1.5 text-sm rounded-md font-medium text-indigo-100 hover:bg-indigo-600 transition duration-300 flex items-center gap-1.5 sm:px-4 sm:py-2 sm:text-base sm:gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2.75 9a.75.75 0 000 1.5h14.5a.75.75 0 000-1.5H2.75z" fill-rule="evenodd" clip-rule="evenodd" /></svg>
                        <span class="whitespace-nowrap">មើលប្រវត្តិទិន្នន័យ</span>
                    </button>
                </div>
            </div>
            <!-- Theme Toggle Button (Updated Hover Color) -->
            <button id="themeToggleBtn" class="p-2 rounded-md hover:bg-indigo-600 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" id="lightIcon" class="h-6 w-6 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg xmlns="http://www.w3.org/2000/svg" id="darkIcon" class="h-6 w-6 text-gray-200 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0015.354 20.354 9.003 9.003 0 0020.354 15.354z" /></svg>
            </button>
        </nav>
        
        <!-- Content Area -->
        <div id="contentArea" class="p-4 flex-grow">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 space-y-8">
                <!-- Dashboard View -->
                <div id="dashboardView" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-center w-full">
                            <h1 class="text-3xl font-bold text-gray-800">កម្មវិធីគ្រប់គ្រងការលក់_YL</h1>
                            <p class="text-gray-500 mt-2">កត់ត្រា និងបោះពុម្ពវិក្កយបត្រលក់</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">ផ្ទាំងគ្រប់គ្រង</h2>
                        <!-- UPDATED: Grid layout for more filters -->
                        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"> 
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700">ចាប់ពីថ្ងៃ</label>
                                <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            
                            <!-- NEW Delivery Option Filter -->
                            <div>
                                <label for="dashboardDeliveryFilter" class="block text-sm font-medium text-gray-700">តម្រងសេវាដឹក</label>
                                <select id="dashboardDeliveryFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="All">ទាំងអស់</option>
                                    <option value="VET">VET</option>
                                    <option value="J&T">J&T</option>
                                    <option value="ភ្នំពេញ">ភ្នំពេញ</option>
                                    <option value="មិនបានជ្រើសរើស">មិនបានជ្រើសរើស</option>
                                </select>
                            </div>

                            <!-- NEW Payment Status Filter -->
                            <div>
                                <label for="dashboardPaymentStatusFilter" class="block text-sm font-medium text-gray-700">ស្ថានភាពទូទាត់</label>
                                <select id="dashboardPaymentStatusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="All">ទាំងអស់</option>
                                    <option value="Paid">បានបង់រួច</option>
                                    <option value="Unpaid">មិនទាន់បង់</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-indigo-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-indigo-700 font-medium">ចំនួនការលក់សរុប (វិក្កយបត្រ)</p>
                                <p id="totalSalesCount" class="text-3xl font-bold text-indigo-800 mt-1">0</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-green-700 font-medium">ចំណូលសរុប (ដុល្លារ)</p>
                                <p id="totalRevenue" class="text-3xl font-bold text-green-800 mt-1">$0.00</p>
                            </div>
                            <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-yellow-700 font-medium">ចំណូលពីសេវាដឹក</p>
                                <p id="totalDeliveryFee" class="text-3xl font-bold text-yellow-800 mt-1">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Sales Form View (now "ព័ត៌មានអតិថិជន") -->
                <div id="customerInfoView" class="hidden">
                    <!-- Customer Information Form -->
                    <div class="bg-white rounded-lg p-6 shadow-md space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">ព័ត៌មានអតិថិជន</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="customerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជន</label>
                                <input type="text" id="customerName" placeholder="ឧទា: កញ្ញា សូជីន" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            
                            <!-- Removed facebookProfileUrl -->

                            <div>
                                <label for="customerPhone" class="block text-sm font-medium text-gray-700">លេខទូរស័ព្ទ</label>
                                <input type="text" id="customerPhone" placeholder="012 345 678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div class="md:col-span-1">
                                <label for="customerAddress" class="block text-sm font-medium text-gray-700">អាសយដ្ឋាន</label>
                                <input type="text" id="customerAddress" placeholder="ភូមិ X ឃុំ Y" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសហាង</h3>
                            <div class="mt-2 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="ccrOnlineCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="ccrOnlineCheckbox" class="ml-2 block text-sm text-gray-900">CCR Online Store</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="yl99CcrCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="yl99CcrCheckbox" class="ml-2 block text-sm text-gray-900">YL 99CCR</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="ccr168Checkbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="ccr168Checkbox" class="ml-2 block text-sm text-gray-900">CCR168</label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសសម្រាប់ការដឹកជញ្ជូន</h3>
                            <div class="mt-2 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="vetRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="vetRadio" class="ml-2 block text-sm text-gray-900">VET</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="jtRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="jtRadio" class="ml-2 block text-sm text-gray-900">J&T</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="phnompenhRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="phnompenhRadio" class="ml-2 block text-sm text-gray-900">ភ្នំពេញ</label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសការទូទាត់</h3>
                            <div class="mt-2 space-y-4">
                                <!-- UPDATED: Changed grid to grid-cols-6 for a single row layout -->
                                <div class="grid grid-cols-6 gap-x-2 gap-y-1"> 
                                    <div class="flex items-center">
                                        <input id="acCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="acCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">AC</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="abaCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="abaCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">ABA</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="wingCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="wingCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">Wing</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="trueEmoneyCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="trueEmoneyCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">True Emoney</label>
                                    </div>      
                                    <div class="flex items-center">
                                        <input id="byDelivererCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="byDelivererCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">តាមអ្នកដឹក</label>
                                    </div>
                                    
                                    <!-- NEW Checkbox for Other Bank -->
                                    <div class="flex items-center">
                                        <input id="otherBankCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="otherBankCheckbox" class="ml-1 block text-sm text-gray-900 whitespace-nowrap">ធនាគារផ្សេង</label>
                                    </div>

                                </div>
                                
                                <!-- NEW INPUT for Other Bank/Payment Method (Conditionally visible) -->
                                <div id="otherPaymentMethodContainer" class="hidden"> 
                                    <label for="otherPaymentMethod" class="block text-sm font-medium text-gray-700 mt-2">ឈ្មោះធនាគារ/ការទូទាត់ផ្សេងទៀត</label>
                                    <input type="text" id="otherPaymentMethod" placeholder="ដូចជា: ធនាគារ Wing Bank, វីង, ផ្សេងៗ..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>

                                <div>
                                    <label for="paymentNotes" class="block text-sm font-medium text-gray-700 mt-2">កំណត់សម្គាល់បន្ថែម (លេខ TxD)</label>
                                    <input type="text" id="paymentNotes" placeholder="ដាក់លេខTxd ..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">សេវាដឹក</h3>
                            <div class="mt-2">
                                <label for="deliveryFee" class="block text-sm font-medium text-gray-700">តម្លៃសេវាដឹក (ដុល្លារ)</label>
                                <input type="number" id="deliveryFee" placeholder="0.00" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                    </div>

                    <!-- Input Form -->
                    <div class="bg-white rounded-lg p-6 shadow-md space-y-4 mt-6">
                        <h2 class="text-xl font-semibold text-gray-700">បញ្ចូលព័ត៌មានការលក់</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="col-span-1 md:col-span-2">
                                <label for="itemName" class="block text-sm font-medium text-gray-700">ឈ្មោះទំនិញ</label>
                                <div class="relative">
                                    <input type="text" id="itemName" list="productNames" placeholder="ដូចជា: ក្រែមលាបមុខ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <svg class="absolute right-3 top-1/2 -mt-2.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <datalist id="productNames">
                                    <!-- Dynamic options will be inserted here by JavaScript -->
                                </datalist>
                            </div>
                            <div>
                                <label for="itemQuantity" class="block text-sm font-medium text-gray-700">ចំនួន</label>
                                <input type="number" id="itemQuantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="itemPrice" class="block text-sm font-medium text-gray-700">តម្លៃ (ដុល្លារ)</label>
                                <input type="number" id="itemPrice" placeholder="0.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button id="addItemBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-sm">
                                បន្ថែមទំនិញ
                            </button>
                            <button id="clearFormBtn" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition duration-300 shadow-sm">
                                ជម្រះទិន្នន័យ
                            </button>
                        </div>
                    </div>

                    <!-- Sales Table -->
                    <div class="bg-white rounded-lg p-6 shadow-md mt-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">បញ្ជីការលក់</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ល.រ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ឈ្មោះទំនិញ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ចំនួន
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            តម្លៃ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ផលបូក
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            លុប
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="salesList" class="bg-white divide-y divide-gray-200">
                                    <!-- Sales items will be inserted here by JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-gray-50">
                                        <td colspan="4" class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-gray-900">
                                            សរុប:
                                        </td>
                                        <td id="totalAmount" class="px-6 py-4 whitespace-nowrap text-left text-base font-bold text-gray-900">
                                            $0.00
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Action Buttons for Customer Info View -->
                    <div class="flex justify-center md:justify-end space-x-4 mt-6">
                        <!-- NEW SAVE BUTTON -->
                        <button id="saveOnlyBtn" class="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M15 6a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path fill-rule="evenodd" d="M3.75 3A1.75 1.75 0 002 4.75v10.5c0 .966.784 1.75 1.75 1.75h12.5A1.75 1.75 0 0018 15.25V7.5A.5.5 0 0017.5 7h-2.5a.5.5 0 000 1h2.21l-3.32 3.32a.75.75 0 01-1.06 0l-3.22-3.22a.75.75 0 010-1.06l3.22-3.22a.75.75 0 011.06 0l2.79 2.79A1.75 1.75 0 0017.25 5H3.75zM10 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                            </svg>
                            រក្សាទុកតែប៉ុណ្ណោះ
                        </button>
                        <button id="printBtn" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5V4h6v5H7zm6 3H7v4h6v-4z" clip-rule="evenodd" />
                            </svg>
                            បោះពុម្ពវិក្កយបត្រ
                        </button>
                        <button id="clearCurrentListBtn" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 112 0v5a1 1 0 11-2 0v-5z" clip-rule="evenodd" />
                            </svg>
                            ជម្រះបញ្ជីបច្ចុប្បន្ន
                        </button>
                    </div>
                </div>

                <!-- Add Item View -->
                <div id="addItemView" class="hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">បន្ថែមទំនិញថ្មី </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="newProductName" class="block text-sm font-medium text-gray-700">ឈ្មោះទំនិញ</label>
                                <input type="text" id="newProductName" placeholder="ដូចជា: ក្រែមលាបមុខ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="newProductPrice" class="block text-sm font-medium text-gray-700">តម្លៃ (ដុល្លារ)</label>
                                <input type="number" id="newProductPrice" placeholder="0.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button id="addNewProductBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-sm">
                                បន្ថែមទំនិញ
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-6 shadow-md mt-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">បញ្ជីទំនិញ</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ឈ្មោះទំនិញ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            តម្លៃ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            លុប
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="productsList" class="bg-white divide-y divide-gray-200">
                                    <!-- Product list will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Data History View -->
                <div id="historyView" class="hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">ប្រវត្តិទិន្នន័យ</h2>
                            <!-- MOVED DOWNLOAD BUTTON TO TOP -->
                            <button id="downloadDataBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-sm flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                ទាញយកទិន្នន័យ
                            </button>
                        </div>
                        <div class="mb-4 space-y-4 p-4 border rounded-md bg-gray-50">
                            <h3 class="text-lg font-medium text-gray-700">តម្រងទិន្នន័យ (Filter)</h3>
                             <div class="flex flex-col sm:flex-row gap-4">
                                <div>
                                    <label for="historyStartDate" class="block text-sm font-medium text-gray-700">ចាប់ពីថ្ងៃ</label>
                                    <input type="date" id="historyStartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                </div>
                                <div>
                                    <label for="historyEndDate" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                    <input type="date" id="historyEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                </div>
                            </div>
                            <div>
                                <label for="searchQuery" class="block text-sm font-medium text-gray-700">ស្វែងរក</label>
                                <input type="text" id="searchQuery" placeholder="ស្វែងរកតាមលេខវិក្កយបត្រ ឈ្មោះអតិថិជន លេខទូរស័ព្ទ ឬអាសយដ្ឋាន..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>

                            <!-- NEW: Sort By Dropdown -->
                            <div>
                                <label for="historySortBy" class="block text-sm font-medium text-gray-700">រៀបតាម</label>
                                <select id="historySortBy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                    <option value="newest">កាលបរិច្ឆេទ (ថ្មីទៅចាស់)</option>
                                    <option value="oldest">កាលបរិច្ឆេទ (ចាស់ទៅថ្មី)</option>
                                    <option value="phnom_penh_first">ទីតាំង (ភ្នំពេញមុន)</option>
                                    <option value="province_first">ទីតាំង (ខេត្តមុន)</option>
                                    <option value="paid_first">ការទូទាត់ (បង់រួចមុន)</option>
                                    <option value="unpaid_first">ការទូទាត់ (មិនទាន់បង់មុន)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- UPDATED CONTROL BAR FOR MULTI-PRINT -->
                        <div class="flex justify-between items-center mb-4 mt-6 flex-wrap gap-2">
                            <div class="flex items-center space-x-2">
                                <button id="selectAllBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300 shadow-sm flex items-center gap-2">
                                    ជ្រើសរើសទាំងអស់
                                </button>
                                <button id="printSelectedBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-sm flex items-center gap-2 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5V4h6v5H7zm6 3H7v4h6v-4z" clip-rule="evenodd" /></svg>
                                    បោះពុម្ពដែលបានជ្រើសរើស
                                </button>
                            </div>
                            <div id="selectedCountDisplay" class="text-sm text-gray-700 font-medium hidden whitespace-nowrap">0 វិក្កយបត្របានជ្រើសរើស</div>
                        </div>

                        <!-- NEW Pagination Controls Container -->
                        <div id="paginationControls" class="flex justify-center items-center space-x-2 mt-6">
                            <!-- Pagination buttons will be inserted here -->
                        </div>

                        <div id="historyListContainer" class="space-y-4 mt-6">
                            <!-- History items will be inserted here as cards by JavaScript -->
                            <p class="text-center text-gray-500">កំពុងផ្ទុកប្រវត្តិទិន្នន័យ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        // --- Firebase Setup ---
        // Configuration details for your Firebase project (Hardcoded for testing as requested by the user)
        const firebaseConfig = {
            apiKey: "AIzaSyDx53uucVLn2qZpKHgm4Zfmn0oq7IqWKDE",
            authDomain: "my-online-sale-re.firebaseapp.com",
            projectId: "my-online-sale-re",
            storageBucket: "my-online-sale-re.firebasestorage.app",
            messagingSenderId: "897696868123",
            appId: "1:897696868123:web:a1c31ba969f90ababb15be",
            measurementId: "G-RP5KG6GY4Y"
        };
        // Use the hardcoded projectId, but prefer the environment variable if available (as mandated)
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        let db = null;
        let auth = null;
        let userId = null;
        let unsubscribeInvoices = null;
        let unsubscribeProducts = null;
        let historyInvoices = [];
        let products = [];
        let currentInvoiceItems = [];
        let isAuthReady = false;
        
        // Pagination settings and multi-select state
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let selectedInvoiceIds = new Set(); 

        const mainApp = document.getElementById('mainApp');
        const loadingView = document.getElementById('loadingView');
        
        let app = null;
        
        // --- DOM REFERENCES ---
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const modalRichContent = document.getElementById('modalRichContent'); // New element for rich conflict message

        const editModal = document.getElementById('editModal');
        const editDocIdInput = document.getElementById('editDocId');
        const editCustomerNameInput = document.getElementById('editCustomerName');
        const editCustomerPhoneInput = document.getElementById('editCustomerPhone');
        const editCustomerAddressInput = document.getElementById('editCustomerAddress');
        const editDeliveryOptionSelect = document.getElementById('editDeliveryOption');
        const editDeliveryFeeInput = document.getElementById('editDeliveryFee');
        const editSaveBtn = document.getElementById('editSaveBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');
        // NEW Edit modal elements
        const editStoreNameSelect = document.getElementById('editStoreName');
        // const editPaymentOptionInput = document.getElementById('editPaymentOption'); // REMOVED
        const editPaymentOptionSelect = document.getElementById('editPaymentOptionSelect'); // NEW SELECT
        const editOtherPaymentContainer = document.getElementById('editOtherPaymentContainer'); // NEW CONTAINER
        const editOtherPaymentInput = document.getElementById('editOtherPaymentInput'); // NEW INPUT
        const editPaymentNotesInput = document.getElementById('editPaymentNotes');
        // Removed editFacebookProfileUrlInput


        let confirmationCallback = null;

        // Get all necessary HTML elements (continued)
        const dashboardView = document.getElementById('dashboardView');
        const customerInfoView = document.getElementById('customerInfoView');
        const addItemView = document.getElementById('addItemView');
        const historyView = document.getElementById('historyView');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        const historyStartDateInput = document.getElementById('historyStartDate');
        const historyEndDateInput = document.getElementById('historyEndDate');
        
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const customerAddressInput = document.getElementById('customerAddress');
        // Removed facebookProfileUrlInput

        const ccrOnlineCheckbox = document.getElementById('ccrOnlineCheckbox');
        const yl99CcrCheckbox = document.getElementById('yl99CcrCheckbox');
        const ccr168Checkbox = document.getElementById('ccr168Checkbox');
        const vetRadio = document.getElementById('vetRadio');
        const jtRadio = document.getElementById('jtRadio');
        const phnompenhRadio = document.getElementById('phnompenhRadio');
        const acCheckbox = document.getElementById('acCheckbox');
        const abaCheckbox = document.getElementById('abaCheckbox');
        const wingCheckbox = document.getElementById('wingCheckbox');
        const trueEmoneyCheckbox = document.getElementById('trueEmoneyCheckbox');
        const byDelivererCheckbox = document.getElementById('byDelivererCheckbox');
        const otherBankCheckbox = document.getElementById('otherBankCheckbox'); // EXISTING
        const otherPaymentMethodInput = document.getElementById('otherPaymentMethod'); // EXISTING
        const otherPaymentMethodContainer = document.getElementById('otherPaymentMethodContainer'); // ADDED
        const paymentNotesInput = document.getElementById('paymentNotes');
        const deliveryFeeInput = document.getElementById('deliveryFee');
        const itemNameInput = document.getElementById('itemName');
        const productNamesDatalist = document.getElementById('productNames');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemPriceInput = document.getElementById('itemPrice');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const salesListBody = document.getElementById('salesList');
        const historyListContainer = document.getElementById('historyListContainer');
        const totalAmountDisplay = document.getElementById('totalAmount');
        const printBtn = document.getElementById('printBtn');
        const saveOnlyBtn = document.getElementById('saveOnlyBtn'); 
        const clearCurrentListBtn = document.getElementById('clearCurrentListBtn');
        const downloadDataBtn = document.getElementById('downloadDataBtn');
        const searchQueryInput = document.getElementById('searchQuery');
        const historySortBySelect = document.getElementById('historySortBy'); // NEW Sort Select
        
        const totalSalesCountDisplay = document.getElementById('totalSalesCount');
        const totalRevenueDisplay = document.getElementById('totalRevenue');
        const totalDeliveryFeeDisplay = document.getElementById('totalDeliveryFee');

        // New elements for Add Item page
        const newProductNameInput = document.getElementById('newProductName');
        const newProductPriceInput = document.getElementById('newProductPrice');
        const addNewProductBtn = document.getElementById('addNewProductBtn');
        const productsListBody = document.getElementById('productsList');

        // Navigation buttons
        const dashboardNavBtn = document.getElementById('dashboardNavBtn');
        const customerInfoNavBtn = document.getElementById('customerInfoNavBtn');
        const addItemNavBtn = document.getElementById('addItemNavBtn');
        const historyNavBtn = document.getElementById('historyNavBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const lightIcon = document.getElementById('lightIcon');
        const darkIcon = document.getElementById('darkIcon');

        // NEW: History View Bulk Print Elements
        const printSelectedBtn = document.getElementById('printSelectedBtn');
        const selectedCountDisplay = document.getElementById('selectedCountDisplay');
        const selectAllBtn = document.getElementById('selectAllBtn'); // ADDED
        const paginationControls = document.getElementById('paginationControls'); // ADDED

        // NEW Dashboard Filter Elements
        const dashboardDeliveryFilter = document.getElementById('dashboardDeliveryFilter');
        const dashboardPaymentStatusFilter = document.getElementById('dashboardPaymentStatusFilter');
        
        
        // --- FUNCTION DEFINITIONS (Moved up to ensure hoisting is not an issue for const/async functions) ---
        
        const showMessage = (message) => {
            modalMessage.textContent = message;
            modalRichContent.innerHTML = ''; 
            messageModal.style.display = 'flex';
        };
        
        const showRichMessage = (title, htmlContent) => {
            modalMessage.textContent = title;
            modalRichContent.innerHTML = htmlContent;
            messageModal.style.display = 'flex';
        };

        const showConfirmation = (message, callback) => {
            confirmMessage.textContent = message;
            confirmationCallback = callback;
            confirmModal.style.display = 'flex';
        };
        
        /**
         * Removes all non-digit characters from a string.
         * @param {string} numberString - The input string (may contain spaces/dashes).
         * @returns {string} The cleaned digit string.
         */
        const cleanPhoneNumber = (numberString) => (numberString || '').replace(/\D/g, '');

        /**
         * Formats the phone number input to the Cambodian standard (max 10 digits, 0-prefix, XXX XXX XXXX spacing).
         * Ensures cursor position is maintained during input, particularly when '0' is implicitly added.
         * @param {HTMLInputElement} input - The phone input element.
         * @returns {void}
         */
        const formatPhoneNumber = (input) => {
            const originalValue = input.value;
            const originalCursorPos = input.selectionStart;

            // 1. Calculate how many digits precede the cursor in the original (clean) input.
            const digitsBeforeCursor = originalValue.substring(0, originalCursorPos).replace(/\D/g, '').length;
            
            // 2. Prepend '0' if needed and calculate the new clean value.
            let cleanNumber = cleanPhoneNumber(originalValue);
            let prependedZero = false;

            if (cleanNumber.length > 0 && cleanNumber[0] !== '0') {
                 // Check if the first digit typed by the user was NOT '0'
                 if (cleanNumber[0] !== '0') {
                    cleanNumber = '0' + cleanNumber;
                    prependedZero = true;
                 }
            }
            const MAX_DIGITS = 10;
            cleanNumber = cleanNumber.substring(0, MAX_DIGITS);

            // 3. Determine the desired cursor position in the digits string.
            let desiredDigitPos = digitsBeforeCursor;
            
            // If '0' was prepended, and the user's cursor was NOT at position 0, the digit count has increased by one.
            // This is the core fix: account for the implicitly added '0' when calculating the position of the cursor's target digit.
            if (prependedZero && originalCursorPos > 0) {
                 desiredDigitPos = digitsBeforeCursor + 1;
            }

            // 4. Format the clean number (XXX XXX XXXX spacing)
            let formattedNumber = '';
            if (cleanNumber.length > 0) {
                formattedNumber += cleanNumber.substring(0, 3);
            }
            if (cleanNumber.length > 3) {
                formattedNumber += ' ' + cleanNumber.substring(3, 6);
            }
            if (cleanNumber.length > 6) {
                formattedNumber += ' ' + cleanNumber.substring(6, 10);
            }
            
            // 5. Find the corresponding cursor position in the formatted string.
            let newCursorPos = 0;
            let digitsCount = 0;
            
            for(let i = 0; i < formattedNumber.length; i++) {
                if (formattedNumber[i].match(/\d/)) {
                    digitsCount++;
                }
                if (digitsCount === desiredDigitPos) {
                    // Position after the last desired digit
                    newCursorPos = i + 1;
                    break;
                }
                if (i === formattedNumber.length - 1) {
                    newCursorPos = formattedNumber.length;
                }
            }
            
            // Apply new value and position
            newCursorPos = Math.min(newCursorPos, formattedNumber.length);
            input.value = formattedNumber;
            input.setSelectionRange(newCursorPos, newCursorPos);
        };
        
        const toggleOtherPaymentInput = () => {
            if (otherBankCheckbox && otherPaymentMethodContainer) {
                if (otherBankCheckbox.checked) {
                    otherPaymentMethodContainer.classList.remove('hidden');
                    otherPaymentMethodInput.focus();
                } else {
                    otherPaymentMethodContainer.classList.add('hidden');
                    otherPaymentMethodInput.value = ''; 
                }
            }
        };
        
        const handleStoreSelection = (selectedCheckbox) => {
            [ccrOnlineCheckbox, yl99CcrCheckbox, ccr168Checkbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
        };
        
        const handlePaymentSelection = (selectedCheckbox) => {
            [acCheckbox, abaCheckbox, wingCheckbox, trueEmoneyCheckbox, byDelivererCheckbox, otherBankCheckbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
            toggleOtherPaymentInput();
        };

        const fillCustomerData = (invoice) => {
            customerNameInput.value = invoice.customerName || '';
            customerAddressInput.value = invoice.customerAddress || '';
            customerPhoneInput.value = invoice.customerPhone || '';
            formatPhoneNumber(customerPhoneInput); 

            vetRadio.checked = false;
            jtRadio.checked = false;
            phnompenhRadio.checked = false;
            
            if (invoice.deliveryOption === 'VET') vetRadio.checked = true;
            else if (invoice.deliveryOption === 'J&T') jtRadio.checked = true;
            else if (invoice.deliveryOption === 'ភ្នំពេញ') phnompenhRadio.checked = true;
        };

        const populateProductDatalist = () => {
            productNamesDatalist.innerHTML = '';
            const allProductNames = new Set();
            products.forEach(product => {
                if (product.name) {
                    allProductNames.add(product.name);
                }
            });

            allProductNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                productNamesDatalist.appendChild(option);
            });
        };

        const getStoreName = () => {
            if (ccrOnlineCheckbox.checked) return 'CCR Online Store';
            if (yl99CcrCheckbox.checked) return 'YL 99CCR';
            if (ccr168Checkbox.checked) return 'CCR168';
            return 'វិក្កយបត្រ';
        };

        const getDeliveryOptions = () => {
            if (vetRadio.checked) return 'VET';
            if (jtRadio.checked) return 'J&T';
            if (phnompenhRadio.checked) return 'ភ្នំពេញ';
            return 'មិនបានជ្រើសរើស';
        };

        const getPaymentOptions = () => {
            let options = [];
            if (acCheckbox.checked) options.push('AC');
            if (abaCheckbox.checked) options.push('ABA');
            if (wingCheckbox.checked) options.push('Wing');
            if (trueEmoneyCheckbox.checked) options.push('True money'); 
            if (byDelivererCheckbox.checked) options.push('តាមអ្នកដឹក');
            
            if (otherBankCheckbox.checked) {
                const customPayment = otherPaymentMethodInput.value.trim();
                options.push(customPayment || 'ធនាគារផ្សេង'); 
            }
            
            return options.join(', ') || 'មិនទាន់វេទឹកប្រាក់';
        };
        
        const clearFormInputs = () => {
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            customerAddressInput.value = '';
            // Removed facebookProfileUrlInput clearing
            vetRadio.checked = false;
            jtRadio.checked = false;
            phnompenhRadio.checked = false;
            ccrOnlineCheckbox.checked = false;
            yl99CcrCheckbox.checked = false;
            ccr168Checkbox.checked = false;
            acCheckbox.checked = false;
            abaCheckbox.checked = false;
            wingCheckbox.checked = false;
            trueEmoneyCheckbox.checked = false;
            byDelivererCheckbox.checked = false;
            otherBankCheckbox.checked = false; 
            otherPaymentMethodInput.value = ''; 
            toggleOtherPaymentInput(); 
            paymentNotesInput.value = '';
            deliveryFeeInput.value = '';
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
        };

        const addItem = () => {
            const name = itemNameInput.value.trim();
            const quantity = parseFloat(itemQuantityInput.value);
            const price = parseFloat(itemPriceInput.value);
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;

            if (!name || isNaN(quantity) || isNaN(price) || quantity <= 0 || price <= 0) {
                showMessage('សូមបញ្ចូលព័ត៌មានទំនិញឲ្យបានគ្រប់គ្រាន់ និងត្រឹមត្រូវ។');
                return;
            }

            const total = quantity * price;
            currentInvoiceItems.push({
                name,
                quantity,
                price,
                total,
                // Capture customer info and other options at the time of item entry 
                customerName: customerNameInput.value.trim(),
                customerPhone: customerPhoneInput.value.trim(),
                customerAddress: customerAddressInput.value.trim(),
                deliveryOption: getDeliveryOptions(),
                paymentOption: getPaymentOptions(),
                paymentNotes: paymentNotesInput.value.trim(),
                deliveryFee: deliveryFee,
                storeName: getStoreName(),
                timestamp: new Date()
            });
            
            // Clear the input fields after successful addition
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
            
            renderSalesList();
        };
        
        const addNewProduct = async () => {
            const productName = newProductNameInput.value.trim();
            const productPrice = parseFloat(newProductPriceInput.value);

            if (!productName || isNaN(productPrice) || productPrice <= 0) {
                showMessage('សូមបញ្ចូលឈ្មោះទំនិញ និងតម្លៃឱ្យបានត្រឹមត្រូវ។');
                return;
            }

            try {
                const existingProduct = products.find(p => p.name.toLowerCase() === productName.toLowerCase());
                
                if (existingProduct) {
                    showMessage('ទំនិញនេះមានរួចហើយនៅក្នុងបញ្ជី។');
                    return;
                }
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/products`), {
                    name: productName,
                    price: productPrice,
                    timestamp: new Date()
                });
                showMessage('បានបន្ថែមទំនិញថ្មីដោយជោគជ័យ។');
                newProductNameInput.value = '';
                newProductPriceInput.value = '';
            } catch (e) {
                console.error("Error adding new product:", e);
                showMessage('មានបញ្ហាក្នុងការបន្ថែមទំនិញថ្មី។');
            }
        };

        const renderProductsList = () => {
            productsListBody.innerHTML = '';
            const sortedProducts = [...products].sort((a, b) => (a.name || "").localeCompare(b.name || "", 'km'));
            sortedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${product.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-product-db text-red-600 hover:text-red-900" data-doc-id="${product.id}">លុប</button>
                    </td>
                `;
                productsListBody.appendChild(row);
            });
            document.querySelectorAll('.delete-product-db').forEach(button => {
                button.addEventListener('click', deleteProductFromDB);
            });
        };

        const deleteProductFromDB = (e) => {
            const docId = e.currentTarget.dataset.docId;
            showConfirmation('តើអ្នកពិតជាចង់លុបទំនិញនេះមែនទេ?', async (result) => {
                if (result) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, docId));
                        showMessage('បានលុបទំនិញដោយជោគជ័យ។');
                    } catch (e) {
                        console.error("Error removing product:", e);
                        showMessage('មានបញ្ហាក្នុងការលុបទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
                    }
                }
            });
        };

        const openEditModal = async (event) => {
            const docId = event.currentTarget.dataset.docId;
            const invoice = historyInvoices.find(inv => inv.id === docId);

            if (!invoice) {
                showMessage('មិនអាចរកវិក្កយបត្រនេះឃើញទេ។');
                return;
            }

            editDocIdInput.value = docId;
            editCustomerNameInput.value = invoice.customerName || '';
            editCustomerPhoneInput.value = invoice.customerPhone || '';
            editCustomerAddressInput.value = invoice.customerAddress || '';
            // Removed editFacebookProfileUrlInput population

            
            // Populate new fields
            editStoreNameSelect.value = invoice.storeName || 'វិក្កយបត្រ';
            
            // Handle Payment Option (NEW LOGIC for dropdown)
            const paymentOptionValue = invoice.paymentOption || 'មិនទាន់វេទឹកប្រាក់';
            const predefinedOptions = ['AC', 'ABA', 'Wing', 'True money', 'តាមអ្នកដឹក', 'មិនទាន់វេទឹកប្រាក់'];
            
            if (predefinedOptions.includes(paymentOptionValue)) {
                editPaymentOptionSelect.value = paymentOptionValue;
                editOtherPaymentContainer.classList.add('hidden');
                editOtherPaymentInput.value = '';
            } else {
                // It's a custom/other payment method (e.g., "ធនាគារ Wing Bank, វីង, ផ្សេងៗ...")
                editPaymentOptionSelect.value = 'ធនាគារផ្សេង';
                editOtherPaymentInput.value = paymentOptionValue;
                editOtherPaymentContainer.classList.remove('hidden');
            }

            editPaymentNotesInput.value = invoice.paymentNotes || '';

            editDeliveryOptionSelect.value = invoice.deliveryOption || 'មិនបានជ្រើសរើស';
            editDeliveryFeeInput.value = (invoice.deliveryFee || 0).toFixed(2);

            editModal.style.display = 'flex';
        };

        const saveEditedInvoice = async () => {
            const docId = editDocIdInput.value;
            const updatedCustomerName = editCustomerNameInput.value.trim();
            const updatedCustomerPhone = editCustomerPhoneInput.value.trim();
            const updatedCustomerAddress = editCustomerAddressInput.value.trim();
            const updatedDeliveryOption = editDeliveryOptionSelect.value;
            const updatedDeliveryFee = parseFloat(editDeliveryFeeInput.value) || 0;
            // Read new fields
            const updatedStoreName = editStoreNameSelect.value;
            const updatedPaymentNotes = editPaymentNotesInput.value.trim();
            // Removed updatedFacebookProfileUrl reading

            // Resolve finalPaymentOption from the new dropdown logic
            let finalPaymentOption;
            if (editPaymentOptionSelect.value === 'ធនាគារផ្សេង') {
                finalPaymentOption = editOtherPaymentInput.value.trim() || 'ធនាគារផ្សេង';
            } else {
                finalPaymentOption = editPaymentOptionSelect.value;
            }


            if (!updatedCustomerName || !updatedCustomerPhone || !updatedCustomerAddress) {
                showMessage('សូមបំពេញឈ្មោះ លេខទូរស័ព្ទ និងអាសយដ្ឋាន។');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, docId);
                
                // Check TxD conflict only if TxD is provided and document ID is different
                if (updatedPaymentNotes.length > 0) {
                    const conflictingInvoice = historyInvoices.find(invoice => 
                        (invoice.paymentNotes || '').trim().toLowerCase() === updatedPaymentNotes.toLowerCase() && invoice.id !== docId
                    );
                    if (conflictingInvoice) {
                        showRichMessage('លេខសម្គាល់TxD/កំណត់សម្គាល់នេះមានរួចហើយនៅក្នុងវិក្កយបត្រផ្សេង!', `
                            <p class="text-red-600 font-bold mb-3">ការព្រមាន៖ លេខ TxD នេះត្រូវបានប្រើប្រាស់រួចហើយដោយវិក្កយបត្រ ${conflictingInvoice.invoiceNumber || 'N/A'}។</p>
                            <div class="modal-buttons">
                                <button onclick="document.getElementById('messageModal').style.display = 'none';" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">បិទ</button>
                            </div>
                            <p class="mt-3 text-sm text-gray-700">សូមកែតម្រូវលេខ TxD នេះ ឬបន្តប្រសិនបើអ្នកប្រាកដថាលេខនេះត្រឹមត្រូវ។</p>
                        `);
                        // Stop the save until the user manually closes the rich message modal.
                        return;
                    }
                }

                await updateDoc(docRef, {
                    customerName: updatedCustomerName,
                    customerPhone: updatedCustomerPhone,
                    customerAddress: updatedCustomerAddress,
                    deliveryOption: updatedDeliveryOption,
                    deliveryFee: updatedDeliveryFee,
                    // NEW: Update fields
                    storeName: updatedStoreName,
                    paymentOption: finalPaymentOption, // Use the new resolved value
                    paymentNotes: updatedPaymentNotes,
                    // Removed facebookProfileUrl update
                    updatedAt: new Date()
                });

                editModal.style.display = 'none';
                showMessage('បានកែប្រែព័ត៌មានអតិថិជនដោយជោគជ័យ។');

            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage('មានបញ្ហាក្នុងការរក្សាទុកការកែប្រែ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        const deleteItemFromDB = async (e) => {
            const docId = e.currentTarget.dataset.docId;
            try {
                showConfirmation('តើអ្នកពិតជាចង់លុបវិក្កយបត្រនេះមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', async (result) => {
                    if (result) {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/invoices`, docId));
                        showMessage('បានលុបវិក្កយបត្រដោយជោគជ័យ។');
                    }
                });
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage('មានបញ្ហាក្នុងការលុបទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        const deleteLocalItem = (e) => {
            const index = e.target.dataset.index;
            currentInvoiceItems.splice(index, 1);
            renderSalesList();
        };

        const renderSalesList = () => {
            salesListBody.innerHTML = '';
            let totalAmount = 0;
            currentInvoiceItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-item-local text-red-600 hover:text-red-900" data-index="${index}">លុប</button>
                    </td>
                `;
                salesListBody.appendChild(row);
                totalAmount += item.total;
            });
            
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
            totalAmountDisplay.textContent = `$${(totalAmount + deliveryFee).toFixed(2)}`;

            // Add event listeners to the new delete buttons
            document.querySelectorAll('.delete-item-local').forEach(button => {
                button.addEventListener('click', deleteLocalItem);
            });
        };

        const updateSelectionDisplay = () => {
            const count = selectedInvoiceIds.size;
            selectedCountDisplay.textContent = `${count} វិក្កយបត្របានជ្រើសរើស`;
            
            if (count > 0) {
                printSelectedBtn.classList.remove('hidden');
                selectedCountDisplay.classList.remove('hidden');
            } else {
                printSelectedBtn.classList.add('hidden');
                selectedCountDisplay.classList.add('hidden');
            }
        };

        const renderPaginationControls = (totalItems) => {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            paginationControls.innerHTML = '';

            if (totalPages <= 1) return;

            const createPageButton = (page, text, disabled) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.className = `px-3 py-1 mx-0.5 rounded-lg text-sm font-medium transition duration-150 shadow-sm ${
                    page === currentPage 
                    ? 'bg-indigo-600 text-white' 
                    : 'bg-white text-gray-700 hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                btn.disabled = disabled;
                btn.addEventListener('click', () => {
                    currentPage = page;
                    renderHistoryList();
                    document.getElementById('historyView').scrollIntoView({ behavior: 'smooth' });
                });
                return btn;
            };

            paginationControls.appendChild(createPageButton(currentPage - 1, 'មុន', currentPage === 1));

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (currentPage <= 3) {
                endPage = Math.min(totalPages, 5);
                startPage = 1;
            } else if (currentPage > totalPages - 3) {
                startPage = Math.max(1, totalPages - 4);
                endPage = totalPages;
            }

            if (startPage > 1) {
                paginationControls.appendChild(createPageButton(1, '1', false));
                if (startPage > 2) {
                     const dots = document.createElement('span');
                     dots.textContent = '...';
                     dots.className = 'px-3 py-1 text-gray-500 dark:text-gray-400';
                     paginationControls.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationControls.appendChild(createPageButton(i, i.toString(), false));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                     const dots = document.createElement('span');
                     dots.textContent = '...';
                     dots.className = 'px-3 py-1 text-gray-500 dark:text-gray-400';
                     paginationControls.appendChild(dots);
                }
                paginationControls.appendChild(createPageButton(totalPages, totalPages.toString(), false));
            }

            paginationControls.appendChild(createPageButton(currentPage + 1, 'បន្ទាប់', currentPage === totalPages));
        };

        const selectAllInvoices = () => {
            const allCheckboxes = document.querySelectorAll('.invoice-select-checkbox');
            const visibleIds = new Set(Array.from(allCheckboxes).map(cb => cb.dataset.invoiceId));
            const currentlySelectedVisibleCount = Array.from(allCheckboxes).filter(cb => selectedInvoiceIds.has(cb.dataset.invoiceId)).length;
            const toggleToSelect = currentlySelectedVisibleCount < allCheckboxes.length;


            allCheckboxes.forEach(checkbox => {
                const invoiceId = checkbox.dataset.invoiceId;
                if (toggleToSelect) {
                    checkbox.checked = true;
                    selectedInvoiceIds.add(invoiceId);
                } else {
                    checkbox.checked = false;
                    selectedInvoiceIds.delete(invoiceId);
                }
            });

            const allSelected = allCheckboxes.length > 0 && selectedInvoiceIds.size === allCheckboxes.length;
            selectAllBtn.textContent = allSelected ? 'ជម្រះការជ្រើសរើស' : 'ជ្រើសរើសទាំងអស់';
            selectAllBtn.classList.toggle('bg-gray-300', !allSelected);
            selectAllBtn.classList.toggle('text-gray-800', !allSelected);
            selectAllBtn.classList.toggle('bg-yellow-500', allSelected);
            selectAllBtn.classList.toggle('hover:bg-yellow-600', allSelected);
            selectAllBtn.classList.toggle('text-white', allSelected);

            updateSelectionDisplay();
        };

        const handleCheckboxChange = (event) => {
            const invoiceId = event.target.dataset.invoiceId;
            if (event.target.checked) {
                selectedInvoiceIds.add(invoiceId);
            } else {
                selectedInvoiceIds.delete(invoiceId);
            }
            updateSelectionDisplay();
            
            const allVisibleCheckboxes = document.querySelectorAll('.invoice-select-checkbox');
            const visibleSelectedCount = Array.from(allVisibleCheckboxes).filter(cb => selectedInvoiceIds.has(cb.dataset.invoiceId)).length;
            const allSelected = allVisibleCheckboxes.length > 0 && visibleSelectedCount === allVisibleCheckboxes.length;
            selectAllBtn.textContent = allSelected ? 'ជម្រះការជ្រើសរើស' : 'ជ្រើសរើសទាំងអស់';
            selectAllBtn.classList.toggle('bg-gray-300', !allSelected);
            selectAllBtn.classList.toggle('text-gray-800', !allSelected);
            selectAllBtn.classList.toggle('bg-yellow-500', allSelected);
            selectAllBtn.classList.toggle('hover:bg-yellow-600', allSelected);
            selectAllBtn.classList.toggle('text-white', allSelected);
        };

        const renderHistoryList = () => {
            const query = searchQueryInput.value.toLowerCase().trim();
            const filterStartDate = historyStartDateInput.value ? new Date(historyStartDateInput.value) : null;
            const filterEndDate = historyEndDateInput.value ? new Date(historyEndDateInput.value) : null;
            const sortBy = historySortBySelect.value; // NEW: Get sort value

            selectedInvoiceIds = new Set([...selectedInvoiceIds].filter(id => historyInvoices.map(inv => inv.id).includes(id)));

            let filteredInvoices = historyInvoices.filter((invoice) => {
                const customerName = (invoice.customerName || '').toLowerCase();
                const customerPhone = (invoice.customerPhone || '').toLowerCase();
                const customerAddress = (invoice.customerAddress || '').toLowerCase();
                const invoiceNumber = (invoice.invoiceNumber || '').toLowerCase();
                
                const hasMatchingItem = invoice.items.some(item => (item.name || '').toLowerCase().includes(query));

                let matchesDate = true;
                const invoiceDate = invoice.timestamp.toDate();
                if (filterStartDate) {
                    const startOfDay = new Date(filterStartDate.getFullYear(), filterStartDate.getMonth(), filterStartDate.getDate(), 0, 0, 0);
                    if (invoiceDate < startOfDay) {
                        matchesDate = false;
                    }
                }
                if (filterEndDate) {
                    const endOfDay = new Date(filterEndDate.getFullYear(), filterEndDate.getMonth(), filterEndDate.getDate(), 23, 59, 59);
                    if (invoiceDate > endOfDay) {
                        matchesDate = false;
                    }
                }

                const matchesSearch = invoiceNumber.includes(query) ||
                        customerName.includes(query) ||
                        customerPhone.includes(query) ||
                        customerAddress.includes(query) ||
                        hasMatchingItem;
                        
                return matchesDate && (query.length === 0 || matchesSearch);
            });

            // NEW: Sort Logic
            filteredInvoices.sort((a, b) => {
                const dateA = a.timestamp.toDate();
                const dateB = b.timestamp.toDate();

                switch (sortBy) {
                    case 'newest':
                        return dateB - dateA;
                    case 'oldest':
                        return dateA - dateB;
                    case 'phnom_penh_first':
                         if (a.deliveryOption === 'ភ្នំពេញ' && b.deliveryOption !== 'ភ្នំពេញ') return -1;
                         if (a.deliveryOption !== 'ភ្នំពេញ' && b.deliveryOption === 'ភ្នំពេញ') return 1;
                         return dateB - dateA; // Fallback to date
                    case 'province_first':
                         if (a.deliveryOption !== 'ភ្នំពេញ' && b.deliveryOption === 'ភ្នំពេញ') return -1;
                         if (a.deliveryOption === 'ភ្នំពេញ' && b.deliveryOption !== 'ភ្នំពេញ') return 1;
                         return dateB - dateA; // Fallback to date
                    case 'paid_first':
                        const paidA = isInvoicePaid(a);
                        const paidB = isInvoicePaid(b);
                        if (paidA && !paidB) return -1;
                        if (!paidA && paidB) return 1;
                        return dateB - dateA;
                    case 'unpaid_first':
                        const unpaidA = !isInvoicePaid(a);
                        const unpaidB = !isInvoicePaid(b);
                        if (unpaidA && !unpaidB) return -1;
                        if (!unpaidA && unpaidB) return 1;
                        return dateB - dateA;
                    default:
                        return dateB - dateA;
                }
            });


            const totalItems = filteredInvoices.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (currentPage > totalPages) {
                currentPage = Math.max(1, totalPages);
            }
            if (currentPage < 1 && totalPages > 0) {
                 currentPage = 1;
            } else if (totalPages === 0) {
                 currentPage = 1; 
            }
            
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;

            const paginatedInvoices = filteredInvoices.slice(startIndex, endIndex);

            historyListContainer.innerHTML = '';

            if (paginatedInvoices.length === 0 && historyInvoices.length > 0) {
                const filterActive = filterStartDate || filterEndDate || query.length > 0;
                historyListContainer.innerHTML = `<p class="text-center text-gray-500">${filterActive ? `រកមិនឃើញលទ្ធផលសម្រាប់តម្រងដែលបានជ្រើសរើសទេ។` : 'គ្មានទិន្នន័យប្រវត្តិ។'}</p>`;
            } else if (historyInvoices.length === 0) {
                historyListContainer.innerHTML = `<p class="text-center text-gray-500">គ្មានទិន្នន័យប្រវត្តិ។</p>`;
            }


            paginatedInvoices.forEach((invoice) => {
                const invoiceDate = invoice.timestamp.toDate().toLocaleDateString('km-KH');
                const invoiceTime = invoice.timestamp.toDate().toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit' });
                const totalAmount = invoice.items.reduce((sum, item) => sum + item.total, 0) + (invoice.deliveryFee || 0);
                const isSelected = selectedInvoiceIds.has(invoice.id); 
                
                // Use lastBulkPrinted to indicate any print action (individual or bulk)
                const isPrinted = invoice.lastBulkPrinted; 
                const printMarkIcon = isPrinted ? 
                    `<span class="ml-2 text-green-600" title="បោះពុម្ពចុងក្រោយ: ${isPrinted.toDate().toLocaleDateString('km-KH')}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 13.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </span>` : '';

                // Facebook Profile Image Logic Removed


                const cardDiv = document.createElement('div');
                cardDiv.className = 'bg-gray-100 rounded-lg shadow-sm p-4 hover:bg-gray-200 transition-colors duration-300 relative';
                
                let itemsListHtml = '';
                invoice.items.forEach(item => {
                    itemsListHtml += `
                        <div class="flex justify-between items-center text-sm py-1 border-b border-gray-300 last:border-b-0">
                            <span class="text-gray-900 font-medium">${item.name}</span>
                            <span class="text-gray-700">${item.quantity} x $${item.price.toFixed(2)}</span>
                            <span class="text-gray-900 font-bold">$${item.total.toFixed(2)}</span>
                        </div>
                    `;
                });

                cardDiv.innerHTML = `
                    <!-- Checkbox for bulk printing -->
                    <input type="checkbox" data-invoice-id="${invoice.id}" ${isSelected ? 'checked' : ''} 
                           class="invoice-select-checkbox absolute top-4 left-4 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer z-10" 
                           style="transform: scale(1.2);">

                    <div class="flex justify-between items-start mb-4 ml-8"> <!-- Added ml-8 for checkbox space -->
                        <div class="flex items-start w-full"> <!-- Flex container for Image + Text -->
                            
                            <div class="flex-grow">
                                <p class="font-bold text-gray-800">លេខវិក្កយបត្រ: ${invoice.invoiceNumber || 'N/A'}</p>
                                <!-- Print mark added here -->
                                <p class="text-sm text-gray-600">សរុប: <strong class="text-base text-green-700">$${totalAmount.toFixed(2)}${printMarkIcon}</strong></p>
                                <p class="text-sm text-gray-600">អតិថិជន: ${invoice.customerName || 'N/A'}</p>
                                <p class="text-sm text-gray-600">ទូរស័ព្ទ: ${invoice.customerPhone || 'N/A'}</p>
                                <p class="text-sm text-gray-600">អាសយដ្ឋាន: ${invoice.customerAddress || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mt-2">${invoiceDate} (${invoiceTime})</p>
                                <p class="text-xs text-gray-500">ហាង: ${invoice.storeName || 'N/A'}</p>
                                <p class="text-xs text-gray-500">កំណត់សម្គាល់/TxD: ${invoice.paymentNotes || 'គ្មាន'}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 flex-shrink-0 ml-2">
                            <button class="edit-invoice text-orange-600 hover:text-orange-800" data-doc-id="${invoice.id}" title="កែប្រែព័ត៌ពីអតិថិជន">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.136 9.142l-.788.788-5.61 5.61a1 1 0 01-1.414 0l-1.414-1.414a1 1 0 010-1.414l5.61-5.61.788-.788 4.243 4.243z" />
                                </svg>
                            </button>
                            <button class="reprint-invoice text-blue-600 hover:text-blue-900" data-doc-id="${invoice.id}" title="បោះពុម្ពឡើងវិញ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5V4h6v5H7zm6 3H7v4h6v-4z" />
                                </svg>
                            </button>
                            <button class="delete-item-db text-red-600 hover:text-red-900" data-doc-id="${invoice.id}" title="លុបវិក្កយបត្រ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="mb-2 text-sm text-gray-700 font-semibold">បញ្ជីទំនិញ</div>
                    <div class="bg-white p-2 rounded-md shadow-inner">
                        ${itemsListHtml}
                    </div>
                `;
                historyListContainer.appendChild(cardDiv);
            });

            renderPaginationControls(totalItems);

            document.querySelectorAll('.delete-item-db').forEach(button => {
                button.addEventListener('click', deleteItemFromDB);
            });
            document.querySelectorAll('.reprint-invoice').forEach(button => {
                button.addEventListener('click', reprintInvoice);
            });
            document.querySelectorAll('.edit-invoice').forEach(button => {
                button.addEventListener('click', openEditModal);
            });
            
            document.querySelectorAll('.invoice-select-checkbox').forEach(checkbox => {
                const invoiceId = checkbox.dataset.invoiceId;
                checkbox.checked = selectedInvoiceIds.has(invoiceId);
                checkbox.addEventListener('change', handleCheckboxChange);
            });
            updateSelectionDisplay(); 
            
            const allVisibleCheckboxes = document.querySelectorAll('.invoice-select-checkbox');
            const visibleSelectedCount = Array.from(allVisibleCheckboxes).filter(cb => selectedInvoiceIds.has(cb.dataset.invoiceId)).length;
            const allSelected = allVisibleCheckboxes.length > 0 && visibleSelectedCount === allVisibleCheckboxes.length;
            selectAllBtn.textContent = allSelected ? 'ជម្រះការជ្រើសរើស' : 'ជ្រើសរើសទាំងអស់';
            selectAllBtn.classList.toggle('bg-gray-300', !allSelected);
            selectAllBtn.classList.toggle('text-gray-800', !allSelected);
            selectAllBtn.classList.toggle('bg-yellow-500', allSelected);
            selectAllBtn.classList.toggle('hover:bg-yellow-600', allSelected);
            selectAllBtn.classList.toggle('text-white', allSelected);
        };

        const printSelectedInvoices = async () => {
            if (selectedInvoiceIds.size === 0) {
                showMessage('សូមជ្រើសរើសវិក្កយបត្រយ៉ាងតិចមួយដើម្បីបោះពុម្ព។');
                return;
            }
            
            showConfirmation(`តើអ្នកពិតជាចង់បោះពុម្ព ${selectedInvoiceIds.size} វិក្កយបត្រមែនទេ?`, async (result) => {
                if (result) {
                    let delay = 0;
                    const printDelayMs = 800; 
                    
                    const invoicesToPrint = historyInvoices
                        .filter(inv => selectedInvoiceIds.has(inv.id))
                        .sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()); 

                    let printedCount = 0;
                    for (const invoice of invoicesToPrint) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        printInvoice(invoice, invoice.invoiceNumber);
                        
                        try {
                            const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, invoice.id);
                            await updateDoc(docRef, {
                                lastBulkPrinted: new Date() 
                            });
                        } catch (e) {
                            console.error(`Error updating printed status for invoice ${invoice.id}:`, e);
                        }
                        
                        delay = printDelayMs;
                        printedCount++;

                        const checkbox = document.querySelector(`.invoice-select-checkbox[data-invoice-id="${invoice.id}"]`);
                        if (checkbox) checkbox.checked = false;
                        selectedInvoiceIds.delete(invoice.id);
                    }
                    
                    updateSelectionDisplay();
                    showMessage(`បានចាប់ផ្តើមដំណើរការបោះពុម្ពសម្រាប់ ${printedCount} វិក្កយបត្រ។`);
                }
            });
        };

        const isInvoicePaid = (invoice) => {
            const paymentOption = (invoice.paymentOption || '').toLowerCase();
            const isUnpaid = paymentOption.includes('តាមអ្នកដឹក') || paymentOption.includes('មិនទាន់វេទឹកប្រាក់');
            return !isUnpaid; 
        };


        const updateDashboard = () => {
            let totalSalesCount = 0; 
            let totalRevenue = 0;
            let totalDeliveryFee = 0;
            
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            const selectedDeliveryOption = dashboardDeliveryFilter.value;
            const selectedPaymentStatus = dashboardPaymentStatusFilter.value;

            const filteredInvoices = historyInvoices.filter(invoice => {
                const invoiceDate = invoice.timestamp.toDate();
                
                let matchesDate = true;
                if (startDate) {
                    const startOfDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0);
                    if (invoiceDate < startOfDay) {
                        matchesDate = false;
                    }
                }
                if (endDate) {
                    const endOfDay = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59);
                    if (invoiceDate > endOfDay) {
                        matchesDate = false;
                    }
                }
                if (!matchesDate) return false;


                if (selectedDeliveryOption !== 'All') {
                    const invoiceDelivery = invoice.deliveryOption || 'មិនបានជ្រើសរើស';
                    if (invoiceDelivery !== selectedDeliveryOption) {
                        return false;
                    }
                }

                if (selectedPaymentStatus === 'Paid') {
                    if (!isInvoicePaid(invoice)) return false;
                } else if (selectedPaymentStatus === 'Unpaid') {
                    if (isInvoicePaid(invoice)) return false;
                }
                
                return true;
            });

            totalSalesCount = filteredInvoices.length;

            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    totalRevenue += item.total;
                });
                totalDeliveryFee += invoice.deliveryFee;
            });
            
            totalSalesCountDisplay.textContent = totalSalesCount;
            totalRevenueDisplay.textContent = `$${totalRevenue.toFixed(2)}`;
            totalDeliveryFeeDisplay.textContent = `$${totalDeliveryFee.toFixed(2)}`;
        };
        
        const saveInvoiceTransaction = async (invoiceDetails, shouldPrint) => {
            const { customerName, customerPhone, customerAddress, deliveryOption, paymentOption, paymentNotes, deliveryFee, storeName } = invoiceDetails;
            try {
                const newInvoiceNumber = 'C' + (historyInvoices.length + 1).toString().padStart(7, '0');

                const invoiceData = {
                    customerName,
                    customerPhone, 
                    customerAddress,
                    deliveryOption,
                    paymentOption,
                    paymentNotes,
                    deliveryFee,
                    storeName,
                    items: currentInvoiceItems,
                    timestamp: new Date(),
                    invoiceNumber: newInvoiceNumber,
                    // UPDATED: Use lastBulkPrinted for individual prints too to track any print action
                    lastBulkPrinted: shouldPrint ? new Date() : null,
                    // Removed facebookProfileUrl field
                };
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/invoices`), invoiceData);
                
                if (shouldPrint) {
                    printInvoice(invoiceData, newInvoiceNumber);
                    showMessage('វិក័យប័ត្រត្រូវបានបោះពុម្ព និងទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ។');
                } else {
                    showMessage('ទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ។');
                }

                currentInvoiceItems = [];
                renderSalesList();
                clearFormInputs();
                
            } catch (e) {
                console.error("Error saving invoice:", e);
                showMessage('មានបញ្ហាក្នុងការរក្សាទុកវិក្្កយបត្រ។');
            }
        }
        
        const showConfirmationTxDConflict = (title, invoice, callback) => {
            const itemsHtml = invoice.items.map(item => 
                `<li class="ml-4 list-disc">${item.name} (${item.quantity} x $${item.price.toFixed(2)})</li>`
            ).join('');

            const date = invoice.timestamp.toDate().toLocaleDateString('km-KH');
            const time = invoice.timestamp.toDate().toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit' });
            const invoiceNumber = invoice.invoiceNumber || 'N/A';
            const salesTotal = invoice.items.reduce((sum, item) => sum + item.total, 0);
            const totalAmount = salesTotal + (invoice.deliveryFee || 0);

            const htmlContent = `
                <p class="text-red-600 font-bold mb-3">${title}</p>
                <div class="bg-red-50 p-3 rounded-md border border-red-200 space-y-1 text-gray-800">
                    <p><strong>លេខវិក្្កយបត្រ៖</strong> ${invoiceNumber}</p>
                    <p><strong>ឈ្មោះអតិថិជន៖</strong> ${invoice.customerName || 'N/A'}</p>
                    <p><strong>លេខទូរស័ព្ទ៖៖</strong> ${invoice.customerPhone || 'N/A'}</p>
                    <p><strong>អាសយដ្ឋាន៖</strong> ${invoice.customerAddress || 'N/A'}</p>
                    <p><strong>ជម្រើសហាង៖៖</strong> ${invoice.storeName || 'N/A'}</p>
                    <p><strong>សរុប៖</strong> $${totalAmount.toFixed(2)}</p>
                    <p><strong>កាលបរិច្ឆេទបញ្ជាទិញ៖៖</strong> ${date} (${time})</p>
                    <p class="font-bold mt-2">ទំនិញដែលបានបញ្ជាទិញ៖</p>
                    <ul class="text-sm text-gray-700">
                        ${itemsHtml}
                    </ul>
                </div>
            `;
            
            confirmMessage.textContent = title.split('. ')[0] + '. តើអ្នកចង់បន្តការរក្សាទុកទេ?';
            confirmModal.style.display = 'flex';
            
            const originalModalContent = modalMessage.textContent;
            modalMessage.textContent = 'សូមពិនិត្យមើលឡើងវិញ!';
            modalRichContent.innerHTML = htmlContent;
            messageModal.style.display = 'flex'; 

            confirmationCallback = (result) => {
                messageModal.style.display = 'none'; 
                confirmModal.style.display = 'none';
                modalMessage.textContent = originalModalContent; 
                modalRichContent.innerHTML = ''; 
                callback(result);
            };
        };
        
        const handleSaveAction = async (shouldPrint) => {
            if (currentInvoiceItems.length === 0) {
                showMessage('សូមបន្ថែមទំនិញយ៉ាងតិចមួយមុខដើម្បីរក្សាទុក ឬបោះពុម្ព។');
                return;
            }
            
            const customerPhoneClean = cleanPhoneNumber(customerPhoneInput.value);
            const customerName = customerNameInput.value.trim();
            const customerAddress = customerAddressInput.value.trim();
            const paymentNotes = paymentNotesInput.value.trim();
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
            const storeName = getStoreName();
            const deliveryOption = getDeliveryOptions();
            const paymentOption = getPaymentOptions();
            
            if (!customerName || customerPhoneClean.length < 7 || !customerAddress || storeName === 'វិក្កយបត្រ') {
                showMessage('សូមបំពេញឈ្មោះអតិថិជន លេខទូរស័ព្ទ (យ៉ាងតិច 7 ខ្ទង់) អាសយដ្ឋាន និងជ្រើសរើសហាង។');
                return;
            }
            
            if (paymentNotes.length > 0) {
                 const conflictingInvoice = historyInvoices.find(invoice => 
                     (invoice.paymentNotes || '').trim().toLowerCase() === paymentNotes.toLowerCase()
                   );

                 if (conflictingInvoice) {
                     showConfirmationTxDConflict('កំណត់សម្គាល់នេះត្រូវបានប្រើប្រាស់រួចហើយនៅក្នុងប្រព័ន្ធ។ សូមកែតម្រូវ ឬបន្តប្រសិនបើអ្នកប្រាកដ។', conflictingInvoice, (confirmContinue) => {
                         if (confirmContinue) {
                             saveInvoiceTransaction({
                                 customerName, customerPhone: customerPhoneInput.value.trim(), customerAddress, deliveryOption, paymentOption, paymentNotes, deliveryFee, storeName
                             }, shouldPrint);
                         }
                     });
                     return; 
                 }
            }
            saveInvoiceTransaction({
               customerName, customerPhone: customerPhoneInput.value.trim(), customerAddress, deliveryOption, paymentOption, paymentNotes, deliveryFee, storeName
            }, shouldPrint);
        };

        const reprintInvoice = async (event) => {
            const docId = event.currentTarget.dataset.docId;
            const invoice = historyInvoices.find(inv => inv.id === docId);
            
            if (invoice) {
                printInvoice(invoice, invoice.invoiceNumber);
            } else {
                showMessage('មិនអាចរកវិក្្កយបត្រនេះឃើញទេ។');
            }
        };

        const printInvoice = (invoiceData, invoiceNumber) => {
            
            const now = new Date();
            const formattedDate = now.toLocaleDateString('km-KH', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = now.toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

            const customerName = invoiceData.customerName || "មិនមានឈ្មោះ";
            const customerPhone = invoiceData.customerPhone || "មិនមានលេខទូរស័ព្ទ";
            const customerAddress = invoiceData.customerAddress || "មិនមានអាសយដ្ឋាន";
            const deliveryOption = invoiceData.deliveryOption || "មិនបានជ្រើសរើស";
            const paymentOption = invoiceData.paymentOption || "មិនទាន់វេទឹកប្រាក់"; 
            const paymentNotes = invoiceData.paymentNotes || "គ្មាន";
            const storeName = invoiceData.storeName;
            const salesTotal = invoiceData.items.reduce((sum, item) => sum + item.total, 0);
            const deliveryFee = invoiceData.deliveryFee || 0;
            const finalTotal = salesTotal + deliveryFee;

            let delivererAmountDisplay = '';


            let invoiceHTML = `
                <div class="invoice-print-section" style="width: 80mm; margin-left: -6mm; margin-right: 4mm; padding: 5mm; box-sizing: border-box; font-family: 'Khmer OS Battambang', 'Khmer OS', sans-serif;">
                    <h1 style="font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 5mm;">${storeName}</h1>
                    <div style="font-size: 14px; line-height: 1.5; margin-bottom: 5mm;">
                        <p style="margin: 0; font-weight: bold; text-align: center;">${invoiceNumber}</p>
                        <p style="margin: 0;">ឈ្មោះអតិថិជន: <strong>${customerName}</strong></p>
                        <p style="margin: 0;">លេខទូរស័ព្ទ: <strong style="font-size: 16px;">${customerPhone}</strong></p>
                        <p style="margin: 0;">អាសយដ្ឋាន: <strong style="font-size: 16px;">${customerAddress}</strong></p>
                        <p style="margin: 0;">ដឹកតាម: <strong>${deliveryOption}</strong> | ទូទាត់: <strong>${paymentOption}${delivererAmountDisplay}</strong></p>
                        <p style="margin: 0;">កំណត់សម្គាល់: <strong>${paymentNotes}</strong></p>
                        <p style="margin: 0; text-align: center;"><strong>${formattedDate} (${formattedTime})</strong></p>
                    </div>
                    <hr style="border-top: 1px dashed #000; margin-bottom: 5mm;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; font-weight: bold; padding: 2px 0;">ឈ្មោះទំនិញ</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 10mm;">ចំនួន</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 15mm;">តម្លៃ</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 15mm;">សរុប</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            invoiceData.items.forEach((item, index) => {
                invoiceHTML += `
                    <tr>
                        <td style="padding: 2px 0;">(${index + 1}) ${item.name}</td>
                        <td style="text-align: right; padding: 2px 0;">${item.quantity}</td>
                        <td style="text-align: right; padding: 2px 0;">$${item.price.toFixed(2)}</td>
                        <td style="text-align: right; padding: 2px 0;">$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });

            invoiceHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 5mm;">តម្លៃទំនិញសរុប:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 5mm;">$${salesTotal.toFixed(2)}</td>
                            </tr>
                              <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 2px;">តម្លៃសេវាដឹក:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 2px;">$${deliveryFee.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 2px; font-size: 16px;">តម្លៃសរុបទាំងអស់:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 2px; font-size: 16px;">$${finalTotal.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '_blank', 'height=600,width=800');
            printWindow.document.write('<html><head><title>វិក្្កយបត្រ</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@page { size: 80mm auto; margin: 0; }');
            printWindow.document.write('body{font-family: "Khmer OS Battambang", Arial, sans-serif; font-size: 14px;} table{width: 100%; border-collapse: collapse;} th, td{padding: 2px 0; text-align: left;}');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(invoiceHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        };

        const downloadDataAsCsv = async () => {
            try {
                const filterStartDate = historyStartDateInput.value ? new Date(historyStartDateInput.value) : null;
                const filterEndDate = historyEndDateInput.value ? new Date(historyEndDateInput.value) : null;

                const filteredInvoices = historyInvoices.filter(invoice => {
                    let matchesDate = true;
                    const invoiceDate = invoice.timestamp.toDate();
                    if (filterStartDate) {
                        const startOfDay = new Date(filterStartDate.getFullYear(), filterStartDate.getMonth(), filterStartDate.getDate(), 0, 0, 0);
                        if (invoiceDate < startOfDay) {
                            matchesDate = false;
                        }
                    }
                    if (filterEndDate) {
                        const endOfDay = new Date(filterEndDate.getFullYear(), filterEndDate.getMonth(), filterEndDate.getDate(), 23, 59, 59);
                        if (invoiceDate > endOfDay) {
                            matchesDate = false;
                        }
                    }
                    return matchesDate;
                });
                
                if (filteredInvoices.length === 0) {
                    showMessage('គ្មានទិន្នន័យដើម្បីទាញយកទេ។');
                    return;
                }

                const headers = ["លេខវិក្្កយបត្រ", "ឈ្មោះអតិថិជន", "លេខទូរស័ព្ទ", "អាសយដ្ឋាន", "ឈ្មោះហាង", "ឈ្មោះទំនិញ", "ចំនួន", "តម្លៃ", "ផលបូក", "ជម្រើសដឹកជញ្ជូន", "ជម្រើសការទូទាត់", "កំណត់សម្គាល់", "សេវាដឹក", "កាលបរិច្ឆេទ"]; 
                let csv = "\uFEFF" + headers.join(',') + '\n';
                
                const sortedInvoices = [...filteredInvoices].sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
                
                sortedInvoices.forEach((invoice) => {
                    const invoiceNumber = invoice.invoiceNumber || 'N/A';
                    invoice.items.forEach(item => {
                        const sanitize = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

                        const values = [
                            sanitize(invoiceNumber),
                            sanitize(invoice.customerName || ''),
                            sanitize(cleanPhoneNumber(invoice.customerPhone) || ''), // <<-- MODIFIED: Using cleanPhoneNumber for CSV export
                            sanitize(invoice.customerAddress || ''),
                            sanitize(invoice.storeName || ''),
                            sanitize(item.name || ''),
                            item.quantity,
                            item.price,
                            item.total,
                            sanitize(invoice.deliveryOption || ''),
                            sanitize(invoice.paymentOption || ''),
                            sanitize(invoice.paymentNotes || ''),
                            invoice.deliveryFee,
                            sanitize(invoice.timestamp.toDate())
                        ];
                        csv += values.join(',') + '\n';
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `ទិន្នន័យលក់_${new Date().toLocaleDateString('en-CA')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('ការទាញយកបានចាប់ផ្តើមហើយ។');

            } catch (e) {
                console.error("Error downloading data: ", e);
                showMessage('មានបញ្ហាក្នុងការទាញយកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        const toggleView = (viewToShow) => {
            dashboardView.style.display = 'none';
            customerInfoView.style.display = 'none';
            addItemView.style.display = 'none';
            historyView.style.display = 'none';

            // Reset inactive button styles (now using indigo-100/indigo-600)
            [dashboardNavBtn, customerInfoNavBtn, addItemNavBtn, historyNavBtn].forEach(btn => {
                btn.classList.remove('bg-indigo-900', 'bg-white');
                btn.classList.add('text-indigo-100', 'hover:bg-indigo-600');
            });
            
            // Set active button style (now using bg-indigo-900 text-white)
            const setActiveStyle = (btn) => {
                btn.classList.add('bg-indigo-900', 'text-white', 'hover:bg-indigo-800');
                btn.classList.remove('text-indigo-100', 'hover:bg-indigo-600');
            };

            if (viewToShow === 'dashboard') {
                dashboardView.style.display = 'block';
                setActiveStyle(dashboardNavBtn);
                updateDashboard();
            } else if (viewToShow === 'customerInfo') {
                customerInfoView.style.display = 'block';
                setActiveStyle(customerInfoNavBtn);
            } else if (viewToShow === 'addItem') {
                addItemView.style.display = 'block';
                setActiveStyle(addItemNavBtn);
            } else if (viewToShow === 'history') {
                historyView.style.display = 'block';
                setActiveStyle(historyNavBtn);
                renderHistoryList(); 
            }
        };


        /**
         * Loads public data (invoices and products) from Firestore using real-time listeners.
         */
        async function loadPublicData() {
            loadingView.style.display = 'flex';
            mainApp.style.display = 'none';
            
            try {
                if (unsubscribeInvoices) {
                    unsubscribeInvoices();
                }
                if (unsubscribeProducts) {
                    unsubscribeProducts();
                }

                // Collection paths for public data
                const invoicesCollectionRef = collection(db, `artifacts/${appId}/public/data/invoices`);
                const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);

                // Real-time listener for invoices (History)
                unsubscribeInvoices = onSnapshot(invoicesCollectionRef, (querySnapshot) => {
                    historyInvoices = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        historyInvoices.push({
                            id: doc.id,
                            // Ensure timestamp fields are handled correctly
                            timestamp: data.timestamp || new Date(), 
                            lastBulkPrinted: data.lastBulkPrinted || null, // Field reused for any print action
                            ...data
                        });
                    });
                    // Ensure the newest invoices are first for easy access
                    historyInvoices.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    
                    populateProductDatalist();
                    renderHistoryList();
                    updateDashboard();
                });

                // Real-time listener for products (Add Item page list and datalist source)
                unsubscribeProducts = onSnapshot(productsCollectionRef, (querySnapshot) => {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        products.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderProductsList();
                    populateProductDatalist();
                });
                
                loadingView.style.display = 'none';
                mainApp.style.display = 'flex';
                
            } catch (error) {
                console.error("Firestore error:", error);
                loadingView.style.display = 'none';
                mainApp.style.display = 'flex';
                showMessage('មានបញ្ហាក្នុងការផ្ទុកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        }
        
        // --- AUTH INITIALIZATION ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Function to handle authentication, preferring custom token but falling back to anonymous
            const initialAuth = async () => {
                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        // Attempt to sign in with the custom token provided by the environment
                        await signInWithCustomToken(auth, token);
                    } else {
                        // Fallback to anonymous sign-in if no token is available
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.warn("Custom token sign-in failed. Falling back to anonymous sign-in.", authError);
                    // Handle custom-token-mismatch error by retrying with anonymous sign-in
                    await signInAnonymously(auth);
                }

                // After a successful sign-in (either way), get the current user.
                const user = auth.currentUser;
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authenticated as user:", userId);
                    loadPublicData();
                } else {
                    console.error("Authentication failed. No user object available.");
                    loadingView.style.display = 'none';
                    mainApp.style.display = 'flex';
                    showMessage('ការផ្ទៀងផ្ទាត់បរាជ័យ។ សូមពិនិត្យមើលការកំណត់រចនាសម្ព័ន្ធ Firebase របស់អ្នក។');
                }
            };
            initialAuth();
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8 text-center text-red-600">
                    <p class="text-xl font-bold mb-4">មានបញ្ហាក្នុងការភ្ជាប់ Firebase!</p>
                    <p>សូមបើកកូដរបស់អ្នក ហើយបន្លែមព័ត៌មាន <span class="font-mono">firebaseConfig</span> របស់គម្រោងអ្នក។</p>
                </div>
            `;
        }


        // --- EVENT LISTENERS ---

        if(modalOkBtn) {
            modalOkBtn.addEventListener('click', () => {
                messageModal.style.display = 'none';
            });
        }

        if(confirmYesBtn) {
            confirmYesBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(true);
                }
            });
        }
        if(confirmNoBtn) {
            confirmNoBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(false);
                }
            });
        }
        
        // Event listeners for Edit Modal
        if (editSaveBtn) editSaveBtn.addEventListener('click', saveEditedInvoice);
        if (editCancelBtn) editCancelBtn.addEventListener('click', () => { 
            editModal.style.display = 'none'; 
        });

        // New listener for the select box in the edit modal
        if (editPaymentOptionSelect) {
            editPaymentOptionSelect.addEventListener('change', () => {
                if (editPaymentOptionSelect.value === 'ធនាគារផ្សេង') {
                    editOtherPaymentContainer.classList.remove('hidden');
                    editOtherPaymentInput.focus();
                } else {
                    editOtherPaymentContainer.classList.add('hidden');
                    editOtherPaymentInput.value = ''; // Clear custom input when not in use
                }
            });
        }
        
        // --- NEW SORT LISTENER ---
        if (historySortBySelect) {
            historySortBySelect.addEventListener('change', () => {
                currentPage = 1; // Reset to page 1 on sort change
                renderHistoryList();
            });
        }

        if (ccrOnlineCheckbox) ccrOnlineCheckbox.addEventListener('change', () => handleStoreSelection(ccrOnlineCheckbox));
        if (yl99CcrCheckbox) yl99CcrCheckbox.addEventListener('change', () => handleStoreSelection(yl99CcrCheckbox));
        if (ccr168Checkbox) ccr168Checkbox.addEventListener('change', () => handleStoreSelection(ccr168Checkbox));
        
        if (acCheckbox) acCheckbox.addEventListener('change', () => handlePaymentSelection(acCheckbox));
        if (abaCheckbox) abaCheckbox.addEventListener('change', () => handlePaymentSelection(abaCheckbox));
        if (wingCheckbox) wingCheckbox.addEventListener('change', () => handlePaymentSelection(wingCheckbox));
        if (trueEmoneyCheckbox) trueEmoneyCheckbox.addEventListener('change', () => handlePaymentSelection(trueEmoneyCheckbox));
        if (byDelivererCheckbox) byDelivererCheckbox.addEventListener('change', () => handlePaymentSelection(byDelivererCheckbox));
        
        if (otherBankCheckbox) otherBankCheckbox.addEventListener('change', () => {
             handlePaymentSelection(otherBankCheckbox); 
             toggleOtherPaymentInput();
        }); 

        
        let debounceTimer;
        customerPhoneInput.addEventListener('input', (e) => {
            formatPhoneNumber(e.target);
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const finalCleanPhone = cleanPhoneNumber(e.target.value);
                if (finalCleanPhone.length >= 7) { 
                    const latestInvoice = historyInvoices
                        .filter(invoice => cleanPhoneNumber(invoice.customerPhone) === finalCleanPhone)
                        .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())[0];
                    
                    if (latestInvoice) {
                        showConfirmation("អតិថិជនចាស់ តើអ្នកចង់អោយកម្មវិធីបំពេញជំនួសទេ", (result) => {
                            if (result) {
                                fillCustomerData(latestInvoice);
                            }
                        });
                    }
                }
            }, 500);
        });

        paymentNotesInput.addEventListener('input', () => {
            const txd = paymentNotesInput.value.trim();
            if (txd.length > 5) { 
                const conflictingInvoice = historyInvoices.find(invoice => 
                    (invoice.paymentNotes || '').trim().toLowerCase() === txd.toLowerCase()
                );

                if (conflictingInvoice) {
                    showRichMessage('លេខសម្គាល់TxD/កំណត់សម្គាល់នេះមានរួចហើយនៅក្នុងប្រព័ន្ធ!', `
                        <p class="text-red-600 font-bold mb-3">ការព្រមាន៖ កំណត់សម្គាល់នេះត្រូវបានប្រើប្រាស់រួចហើយ។</p>
                        <div class="bg-red-50 p-3 rounded-md border border-red-200 space-y-1 text-gray-800">
                           <p><strong>លេខវិក្្កយបត្រ៖</strong> ${conflictingInvoice.invoiceNumber || 'N/A'}</p>
                           <p><strong>ឈ្មោះអតិថិជន៖៖</strong> ${conflictingInvoice.customerName || 'N/A'}</p>
                           <p><strong>កាលបរិច្ឆេទបញ្ជាទិញ៖</strong> ${conflictingInvoice.timestamp.toDate().toLocaleDateString('km-KH')}</p>
                        </div>
                        <p class="mt-3 text-sm text-gray-700">សូមបន្តការបញ្ចូលទិន្នន័យ។ ការត្រួតពិនិត្យចុងក្រោយនឹងធ្វើឡើងនៅពេលបោះពុម្ព។</p>
                    `);
                } else if (messageModal.style.display === 'flex' && modalRichContent.innerHTML !== '') {
                    messageModal.style.display = 'none';
                }
            } else if (messageModal.style.display === 'flex' && modalRichContent.innerHTML !== '') {
                 messageModal.style.display = 'none';
            }
        });
        
        if (addItemBtn) addItemBtn.addEventListener('click', addItem);
        if (clearFormBtn) clearFormBtn.addEventListener('click', clearFormInputs);
        
        if (printBtn) {
            printBtn.addEventListener('click', () => handleSaveAction(true));
        }
        if (saveOnlyBtn) { 
            saveOnlyBtn.addEventListener('click', () => handleSaveAction(false));
        }
        
        if (clearCurrentListBtn) {
            clearCurrentListBtn.addEventListener('click', () => {
                showConfirmation('តើអ្នកពិតជាចង់លុបបញ្ជីបច្ចុប្បន្នមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', (result) => {
                    if (result) {
                        currentInvoiceItems = [];
                        renderSalesList();
                        clearFormInputs(); 
                        showMessage('បានលុបបញ្ជីបច្ចុប្បន្នដោយជោគជ័យ។');
                    }
                });
            });
        }
        
        if (downloadDataBtn) {
            downloadDataBtn.addEventListener('click', downloadDataAsCsv);
        }

        if (printSelectedBtn) {
            printSelectedBtn.addEventListener('click', printSelectedInvoices);
        }

        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', selectAllInvoices);
        }
        
        if (addNewProductBtn) {
            addNewProductBtn.addEventListener('click', addNewProduct);
        }
        
        if (dashboardNavBtn) dashboardNavBtn.addEventListener('click', () => toggleView('dashboard'));
        if (customerInfoNavBtn) customerInfoNavBtn.addEventListener('click', () => toggleView('customerInfo'));
        if (addItemNavBtn) addItemNavBtn.addEventListener('click', () => toggleView('addItem'));
        if (historyNavBtn) historyNavBtn.addEventListener('click', () => toggleView('history'));

        if (startDateInput) startDateInput.addEventListener('change', updateDashboard);
        if (endDateInput) endDateInput.addEventListener('change', updateDashboard);
        
        if (dashboardDeliveryFilter) dashboardDeliveryFilter.addEventListener('change', updateDashboard);
        if (dashboardPaymentStatusFilter) dashboardPaymentStatusFilter.addEventListener('change', updateDashboard);
        
        const filterListeners = () => {
            currentPage = 1;
            renderHistoryList();
        };

        if (historyStartDateInput) historyStartDateInput.addEventListener('change', filterListeners);
        if (historyEndDateInput) historyEndDateInput.addEventListener('change', filterListeners);
        if (searchQueryInput) searchQueryInput.addEventListener('input', filterListeners);


        document.addEventListener('keypress', (e) => {
            const isItemInput = ['itemName', 'itemQuantity', 'itemPrice'].includes(e.target.id);
            const isSubmitButton = e.target.id === 'addItemBtn';

            if (e.key === 'Enter' && (isItemInput || isSubmitButton)) {
                e.preventDefault(); 
                addItem();
            }
        });

        itemNameInput.addEventListener('input', () => {
            const selectedItemName = itemNameInput.value.trim();
            let product = products.find(p => p.name === selectedItemName);
            
            if (product) {
                itemPriceInput.value = (product.price || 0).toFixed(2);
            } else if (itemPriceInput.value === '' || parseFloat(itemPriceInput.value) === 0) {
                 itemPriceInput.value = '';
            }
        });
        
        if (deliveryFeeInput) deliveryFeeInput.addEventListener('input', renderSalesList);

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                const body = document.body;
                body.classList.toggle('dark-mode');
                
                const isDarkMode = body.classList.contains('dark-mode');
                if (isDarkMode) {
                    lightIcon.style.display = 'none';
                    darkIcon.style.display = 'block';
                } else {
                    lightIcon.style.display = 'block';
                    darkIcon.style.display = 'none';
                }
            });
        }

        // Initial check for custom payment input visibility and view load
        toggleOtherPaymentInput();
        toggleView('dashboard');
    </script>
</body>
</html>
